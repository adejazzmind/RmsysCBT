@model IEnumerable<RmsysCBT.Models.Question>
@{
    ViewData["Title"] = ViewBag.TestTitle;
    int duration = ViewBag.Duration;
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 pb-3 border-bottom gap-3">
                <h2 class="fw-bolder text-primary mb-0">@ViewBag.TestTitle</h2>
                <div class="badge bg-danger text-white fs-5 px-4 py-2 rounded-pill shadow-sm d-flex align-items-center align-self-start align-self-md-auto">
                    <i class="bi bi-stopwatch me-2"></i>
                    <span id="timerDisplay">--:--</span>
                </div>
            </div>

            <form id="examForm" asp-action="Submit" method="post">
                <input type="hidden" name="testId" value="@ViewBag.TestId" />

                @if (!Model.Any())
                {
                    <div class="alert alert-warning text-center rounded-4 p-5 shadow-sm">
                        <i class="bi bi-exclamation-triangle display-4 d-block mb-3 text-warning"></i>
                        <h4 class="fw-bold">No questions available</h4>
                        <p class="mb-0">This exam currently has no questions. Please contact your administrator.</p>
                    </div>
                }
                else
                {
                    int qIndex = 1;
                    foreach (var question in Model)
                    {
                        <div class="card border-0 shadow-sm rounded-4 mb-4">
                            <div class="card-body p-4 p-md-5">
                                <div class="d-flex align-items-start mb-4">
                                    <div class="bg-primary bg-opacity-10 text-primary fw-bold rounded-circle d-flex justify-content-center align-items-center me-3 flex-shrink-0" style="width: 45px; height: 45px; font-size: 1.2rem;">
                                        @qIndex
                                    </div>
                                    <h5 class="fw-bold text-dark lh-base mb-0 pt-2">
                                        @question.Text
                                    </h5>
                                </div>

                                <div class="ps-md-5">
                                    @foreach (var option in question.Options)
                                    {
                                        <div class="form-check custom-radio-block mb-3 p-3 border rounded-3 bg-light transition-all cursor-pointer" onclick="document.getElementById('opt_@option.Id').checked = true;">
                                            <input class="form-check-input border-secondary" style="width: 1.2rem; height: 1.2rem;" type="radio" name="answers[@question.Id]" id="opt_@option.Id" value="@option.Id">
                                            <label class="form-check-label w-100 ms-2 fw-medium text-dark" for="opt_@option.Id" style="cursor: pointer;">
                                                @option.Text
                                            </label>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                        qIndex++;
                    }

                    <div class="text-center mt-5 mb-3">
                        <button type="submit" class="btn btn-success btn-lg rounded-pill px-5 py-3 fw-bold shadow" onclick="return confirm('Are you sure you want to submit your exam? You cannot change your answers after this.');">
                            <i class="bi bi-check-circle me-2"></i> Submit Exam
                        </button>
                    </div>
                }
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Exam Timer Logic
        let durationMinutes = parseInt('@duration');
        let timeRemaining = durationMinutes * 60; // Convert to seconds
        let timerDisplay = document.getElementById('timerDisplay');
        let examForm = document.getElementById('examForm');

        // Pings the server every 5 minutes (300,000 ms) so Render NEVER goes to sleep during an exam!
        setInterval(() => {
            fetch('/').catch(() => {});
        }, 300000);

        function updateTimer() {
            let minutes = Math.floor(timeRemaining / 60);
            let seconds = timeRemaining % 60;

            // Add leading zeros if needed
            let minsStr = minutes < 10 ? '0' + minutes : minutes;
            let secsStr = seconds < 10 ? '0' + seconds : seconds;

            timerDisplay.textContent = minsStr + ':' + secsStr;

            // Warning colors when under 5 minutes
            if (timeRemaining < 300) {
                timerDisplay.parentElement.classList.replace('bg-danger', 'bg-warning');
                timerDisplay.parentElement.classList.add('text-dark');
                timerDisplay.parentElement.classList.remove('text-white');
            }

            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                timerDisplay.textContent = "00:00";
                alert("Time is up! Your exam will now be submitted automatically.");

                // Remove the 'required' attribute from radios so the form can force-submit even if unfinished
                document.querySelectorAll('input[type="radio"]').forEach(radio => radio.removeAttribute('required'));

                examForm.submit();
            }
            timeRemaining--;
        }

        // Make the whole option box highlight on hover via CSS-like behavior
        document.querySelectorAll('.custom-radio-block').forEach(block => {
            block.style.cursor = 'pointer';
            block.addEventListener('mouseenter', () => block.classList.replace('bg-light', 'bg-white'));
            block.addEventListener('mouseleave', () => block.classList.replace('bg-white', 'bg-light'));
        });

        // Start the timer immediately
        updateTimer();
        let timerInterval = setInterval(updateTimer, 1000);
    </script>
}